var Channel=function(){"use strict";function a(a,b,c,d){function f(b){for(var c=0;c<b.length;c++)if(b[c].win===a)return!0;return!1}var g=!1;if("*"===b){for(var h in e)if(e.hasOwnProperty(h)&&"*"!==h&&"object"==typeof e[h][c]&&(g=f(e[h][c])))break}else e["*"]&&e["*"][c]&&(g=f(e["*"][c])),!g&&e[b]&&e[b][c]&&(g=f(e[b][c]));if(g)throw"A channel is already bound to the same window which overlaps with origin '"+b+"' and has scope '"+c+"'";"object"!=typeof e[b]&&(e[b]={}),"object"!=typeof e[b][c]&&(e[b][c]=[]),e[b][c].push({win:a,handler:d})}function b(a,b,c){for(var d=e[b][c],f=0;f<d.length;f++)d[f].win===a&&d.splice(f,1);0===e[b][c].length&&delete e[b][c]}function c(a){return Array.isArray?Array.isArray(a):-1!=a.constructor.toString().indexOf("Array")}var d=Math.floor(1000001*Math.random()),e={},f={},g=function(a){try{var b=JSON.parse(a.data);if("object"!=typeof b||null===b)throw"malformed"}catch(a){return}var c,d,g,h=a.source,i=a.origin;if("string"==typeof b.method){var j=b.method.split("::");2==j.length?(c=j[0],g=j[1]):g=b.method}if("undefined"!=typeof b.id&&(d=b.id),"string"==typeof g){var k=!1;if(e[i]&&e[i][c])for(var l=0;l<e[i][c].length;l++)if(e[i][c][l].win===h){e[i][c][l].handler(i,g,b),k=!0;break}if(!k&&e["*"]&&e["*"][c])for(var l=0;l<e["*"][c].length;l++)if(e["*"][c][l].win===h){e["*"][c][l].handler(i,g,b);break}}else"undefined"!=typeof d&&f[d]&&f[d](i,g,b)};return window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent&&window.attachEvent("onmessage",g),{build:function(e){var g=function(a){if(e.debugOutput&&window.console&&window.console.log){try{"string"!=typeof a&&(a=JSON.stringify(a))}catch(b){}console.log("["+j+"] "+a)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if("object"!=typeof e)throw"Channel build invoked without a proper object argument";if(!e.window||!e.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===e.window)throw"target window is same as present window -- not allowed";var h=!1;if("string"==typeof e.origin){var i;"*"===e.origin?h=!0:null!==(i=e.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))&&(e.origin=i[0].toLowerCase(),h=!0)}if(!h)throw"Channel.build() called with an invalid origin";if("undefined"!=typeof e.scope){if("string"!=typeof e.scope)throw"scope, when specified, must be a string";if(e.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var j=function(){for(var a="",b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}(),k={},l={},m={},n=!1,o=[],p=function(a,b,c){var d=!1,e=!1;return{origin:b,invoke:function(b,d){if(!m[a])throw"attempting to invoke a callback of a nonexistent transaction: "+a;for(var e=!1,f=0;f<c.length;f++)if(b===c[f]){e=!0;break}if(!e)throw"request supports no such callback '"+b+"'";t({id:a,callback:b,params:d})},error:function(b,c){if(e=!0,!m[a])throw"error called for nonexistent message: "+a;delete m[a],t({id:a,error:b,message:c})},complete:function(b){if(e=!0,!m[a])throw"complete called for nonexistent message: "+a;delete m[a],t({id:a,result:b})},delayReturn:function(a){return"boolean"==typeof a&&(d=a===!0),d},completed:function(){return e}}},q=function(a,b,c){return window.setTimeout(function(){if(l[a]){var d="timeout ("+b+"ms) exceeded on method '"+c+"'";l[a].error("timeout_error",d),delete l[a],delete f[a]}},b)},r=function(a,b,d){if("function"==typeof e.gotMessageObserver)try{e.gotMessageObserver(a,d)}catch(h){g("gotMessageObserver() raised an exception: "+h.toString())}if(d.id&&b){if(k[b]){var i=p(d.id,a,d.callbacks?d.callbacks:[]);m[d.id]={};try{if(d.callbacks&&c(d.callbacks)&&d.callbacks.length>0)for(var j=0;j<d.callbacks.length;j++){for(var n=d.callbacks[j],o=d.params,q=n.split("/"),r=0;r<q.length-1;r++){var s=q[r];"object"!=typeof o[s]&&(o[s]={}),o=o[s]}o[q[q.length-1]]=function(){var a=n;return function(b){return i.invoke(a,b)}}()}var t=k[b](i,d.params);i.delayReturn()||i.completed()||i.complete(t)}catch(h){var u="runtime_error",v=null;if("string"==typeof h?v=h:"object"==typeof h&&(h&&c(h)&&2==h.length?(u=h[0],v=h[1]):"string"==typeof h.error&&(u=h.error,h.message?"string"==typeof h.message?v=h.message:h=h.message:v="")),null===v)try{v=JSON.stringify(h),"undefined"==typeof v&&(v=h.toString())}catch(w){v=h.toString()}i.error(u,v)}}}else d.id&&d.callback?l[d.id]&&l[d.id].callbacks&&l[d.id].callbacks[d.callback]?l[d.id].callbacks[d.callback](d.params):g("ignoring invalid callback, id:"+d.id+" ("+d.callback+")"):d.id?l[d.id]?(d.error?l[d.id].error(d.error,d.message):void 0!==d.result?l[d.id].success(d.result):l[d.id].success(),delete l[d.id],delete f[d.id]):g("ignoring invalid response: "+d.id):b&&k[b]&&k[b]({origin:a},d.params)};a(e.window,e.origin,"string"==typeof e.scope?e.scope:"",r);var s=function(a){return"string"==typeof e.scope&&e.scope.length&&(a=[e.scope,a].join("::")),a},t=function(a,b){if(!a)throw"postMessage called with null message";var c=n?"post  ":"queue ";if(g(c+" message: "+JSON.stringify(a)),b||n){if("function"==typeof e.postMessageObserver)try{e.postMessageObserver(e.origin,a)}catch(d){g("postMessageObserver() raised an exception: "+d.toString())}e.window.postMessage(JSON.stringify(a),e.origin)}else o.push(a)},u=function(a,b){if(g("ready msg received"),n)throw"received ready message while in ready state.  help!";for(j+="ping"===b?"-R":"-L",v.unbind("__ready"),n=!0,g("ready msg accepted."),"ping"===b&&v.notify({method:"__ready",params:"pong"});o.length;)t(o.pop());"function"==typeof e.onReady&&e.onReady(v)},v={unbind:function(a){if(k[a]){if(!delete k[a])throw"can't delete method: "+a;return!0}return!1},bind:function(a,b){if(!a||"string"!=typeof a)throw"'method' argument to bind must be string";if(!b||"function"!=typeof b)throw"callback missing from bind params";if(k[a])throw"method '"+a+"' is already bound!";return k[a]=b,this},call:function(a){if(!a)throw"missing arguments to call function";if(!a.method||"string"!=typeof a.method)throw"'method' argument to call must be string";if(!a.success||"function"!=typeof a.success)throw"'success' callback missing from call";var b={},c=[],e=function(a,d){if("object"==typeof d)for(var f in d)if(d.hasOwnProperty(f)){var g=a+(a.length?"/":"")+f;"function"==typeof d[f]?(b[g]=d[f],c.push(g),delete d[f]):"object"==typeof d[f]&&e(g,d[f])}};e("",a.params);var g={id:d,method:s(a.method),params:a.params};c.length&&(g.callbacks=c),a.timeout&&q(d,a.timeout,s(a.method)),l[d]={callbacks:b,error:a.error,success:a.success},f[d]=r,d++,t(g)},notify:function(a){if(!a)throw"missing arguments to notify function";if(!a.method||"string"!=typeof a.method)throw"'method' argument to notify must be string";t({method:s(a.method),params:a.params})},destroy:function(){b(e.window,e.origin,"string"==typeof e.scope?e.scope:""),window.removeEventListener?window.removeEventListener("message",r,!1):window.detachEvent&&window.detachEvent("onmessage",r),n=!1,k={},m={},l={},e.origin=null,o=[],g("channel destroyed"),j=""}};return v.bind("__ready",u),setTimeout(function(){t({method:s("__ready"),params:"ping"},!0)},0),v}}}();!function(a){"use strict";var b=a.prototype,c=b.parseFromString;try{if((new a).parseFromString("","text/html"))return}catch(d){}b.parseFromString=function(a,b){var d,e,f,g;return/^\s*text\/html\s*(?:;|$)/i.test(b)?(e=document.implementation.createHTMLDocument(""),f=e.documentElement,f.innerHTML=a,g=f.firstElementChild,1===f.childElementCount&&"html"===g.localName.toLowerCase()&&e.replaceChild(g,f),d=e):d=c.apply(this,arguments),d}}(DOMParser),"function"!=typeof document.contains&&(Document.prototype.contains=function(a){return a===this||a.parentNode===this?!0:this.documentElement.contains(a)}),function(a){"use strict";function b(b,c){var d,e,f,g="<!doctype><html><head></head></html>";return b&&c?(d=(new a).parseFromString(g,"text/html"),e=d.createElement("base"),f=d.createElement("link"),d.head.appendChild(e),d.head.appendChild(f),e.href=c,f.href=b,f.href):b}function c(a,c){if(void 0!==c){if(!e.test(c))throw new TypeError("Failed to construct 'URL': Invalid base URL");a=b(a,c)}if(!e.test(a))throw new TypeError("Failed to construct 'URL': Invalid URL");this.href=a}try{if("https://example.com/a"===new window.URL("../a","https://example.com/").href)return}catch(d){}var e=/^(?:[a-z]+:)?\/\/|data:/i;c.prototype.href="",window.URL&&window.URL.createObjectURL&&(c.createObjectURL=window.URL.createObjectURL),window.URL&&window.URL.revokeObjectURL&&(c.revokeObjectURL=window.URL.revokeObjectURL),window.URL=c}(DOMParser),function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";function m(a){if(this.name="scopeerror",void 0!==a&&"string"!=typeof a)throw new TypeError("You must pass a string.");this.message=a||"Scope Error"}function n(a,b,d){var e;try{e=a.apply(d,b)}catch(f){return(new c.Queue).push(function(){return c.reject(f)})}return e instanceof c.Queue?e:(new c.Queue).push(function(){return e})}function o(a){var b=new h;return new c.Promise(function(c,d){b.addEventListener("load",function(a){c(a.target.result)}),b.addEventListener("error",d),b.readAsDataURL(a)},function(){b.abort()})}function p(a,b,d,e,f){function g(){void 0!==k&&"function"==typeof k.cancel&&k.cancel()}function h(){void 0!==j&&a.removeEventListener(b,j,d),g()}function i(i,l){var m;j=function(a){f&&(a.stopPropagation(),a.preventDefault()),g();try{m=e(a)}catch(b){m=c.reject(b)}k=m,(new c.Queue).push(function(){return m}).push(void 0,function(a){a instanceof c.CancellationError||(h(),l(a))})},a.addEventListener(b,j,d)}var j,k;return void 0===f&&(f=!0),new c.Promise(i,h)}function q(){function a(){b.cancelAnimationFrame(e)}function d(a){e=b.requestAnimationFrame(a)}var e;return new c.Promise(d,a)}function r(a){function b(b,c){function d(){try{0===e.readyState?c(e):4===e.readyState&&(e.status<200||e.status>=300||!/^text\/html[;]?/.test(e.getResponseHeader("Content-Type")||"")?c(e):b(e))}catch(a){c(a)}}e=new XMLHttpRequest,e.open("GET",a),e.onreadystatechange=d,e.setRequestHeader("Accept","text/html"),e.withCredentials=!0,e.send()}function d(){void 0!==e&&e.readyState!==e.DONE&&e.abort()}var e;return new c.Promise(b,d)}function s(a){var b=a.indexOf("#");return b>0&&(a=a.substring(0,b)),a}function t(c){var d,e,f,g,h,i;if(aa)return console.info("-- Error dropped, as page is unloaded"),void console.info(c);for(ba.push(c),ba.push(new Error("stopping renderJS")),e=a.getElementsByTagName("body")[0];e.firstChild;)e.removeChild(e.firstChild);for(f=a.createElement("section"),g=a.createElement("h1"),g.textContent="Unhandled Error",f.appendChild(g),g=a.createElement("p"),g.textContent="Please report this error to the support team",f.appendChild(g),g=a.createElement("p"),g.textContent="Location: ",h=a.createElement("a"),h.href=h.textContent=b.location.toString(),g.appendChild(h),f.appendChild(g),g=a.createElement("p"),g.textContent="User-agent: "+j.userAgent,f.appendChild(g),g=a.createElement("p"),g.textContent="Date: "+new Date(Date.now()).toISOString(),f.appendChild(g),e.appendChild(f),d=0;d<ba.length;d+=1){if(i=ba[d],i instanceof k&&(i={string:i.toString(),message:i.message,type:i.type,target:i.target},void 0!==i.target&&ba.splice(d+1,0,i.target)),i instanceof XMLHttpRequest&&(i={message:i.toString(),readyState:i.readyState,status:i.status,statusText:i.statusText,response:i.response,responseUrl:i.responseUrl,response_headers:i.getAllResponseHeaders()}),i.constructor===Array||i.constructor===String||i.constructor===Object)try{i=JSON.stringify(i)}catch(l){}f=a.createElement("section"),g=a.createElement("h2"),g.textContent=i.message||i,f.appendChild(g),void 0!==i.fileName&&(g=a.createElement("p"),g.textContent="File: "+i.fileName+": "+i.lineNumber,f.appendChild(g)),void 0!==i.stack&&(g=a.createElement("pre"),g.textContent="Stack: "+i.stack,f.appendChild(g)),e.appendChild(f)}console.error(c.stack),console.error(c)}function u(a){if(this.name="resolved",void 0!==a&&"string"!=typeof a)throw new TypeError("You must pass a string.");this.message=a||"Default Message"}function v(){return this instanceof v?void 0:new v}function w(a){a.hasOwnProperty("__monitor")&&(a.__monitor.cancel(),delete a.__monitor,a.__job_list=[])}function x(a){a.__monitor=new T,a.__job_dict={},a.__job_triggered=!1,a.__monitor.fail(function(b){return b instanceof c.CancellationError?void 0:a.aq_reportServiceError(b)}).fail(t)}function y(a){a.__sub_gadget_dict={},a.__job_list=[],void 0!==a.__json_state&&(a.state=JSON.parse(a.__json_state))}function z(){function a(a){return function(b){var c=j.__acquired_method_dict||{},d="reportGadgetDeclarationError";if(c.hasOwnProperty(d))return c[d].apply(j,[arguments,a]);throw b}}var b,d,e,f,g,h=this.element.querySelectorAll("[data-gadget-url]"),i=[],j=this;for(g=0;g<h.length;g+=1)b=h[g],d=b.getAttribute("data-gadget-scope"),e=b.getAttribute("data-gadget-url"),f=b.getAttribute("data-gadget-sandbox"),null!==e&&i.push(j.declareGadget(e,{element:b,scope:d||void 0,sandbox:f||void 0}).push(void 0,a(d)));return c.all(i)}function A(a,b,d,e){var f=n(d,e,a);a.__job_dict.hasOwnProperty(b)&&a.__job_dict[b].cancel(),a.__job_dict[b]=f,a.__monitor.monitor((new c.Queue).push(function(){return f}).push(void 0,function(a){if(!(a instanceof c.CancellationError))throw a}))}function B(a){(0!==a.constructor.__service_list.length||a.constructor.__job_declared)&&(x(a),a.__monitor.monitor((new c.Queue).push(function(){var b,c=a.constructor.__service_list,d=a.__job_list;for(b=0;b<c.length;b+=1)a.__monitor.monitor(c[b].apply(a));for(b=0;b<d.length;b+=1)A(a,d[b][0],d[b][1],d[b][2]);a.__job_list=[],a.__job_triggered=!0})))}function C(a,b,c){var d,e,f=this,g=f.__acquired_method_dict||{};if(!g.hasOwnProperty(b))return f.__aq_parent(b,c);for(d in f.__sub_gadget_dict)f.__sub_gadget_dict.hasOwnProperty(d)&&f.__sub_gadget_dict[d]===a&&(e=d);return n(g[b],[c,e],f).push(void 0,function(a){if(a instanceof S.AcquisitionError)return f.__aq_parent(b,c);throw a})}function D(a,b){a.__aq_parent=function(c,d){return C.apply(b,[a,c,d])}}function E(){return this instanceof E?void v.call(this):new E}function F(b,c,d){void 0===c.element&&(c.element=a.createElement("div"));var e,f,g=b.__template_element.body.childNodes,h=a.createDocumentFragment();for(f=new b,f.element=c.element,f.state={},e=0;e<g.length;e+=1)h.appendChild(g[e].cloneNode(!0));return f.element.appendChild(h),D(f,d),f}function G(a,b,c){var d=S.declareGadgetKlass(a);return"function"==typeof d.then?d.then(function(a){return F(a,b,c)}):F(d,b,c)}function H(){return this instanceof H?void v.call(this):new H}function I(b,d,f){var g,h,i=c.defer();if(void 0===d.element)throw new Error("DOM element is required to create Iframe Gadget "+b);if(!a.contains(d.element))throw new Error("The parent element is not attached to the DOM for "+b);return g=new H,D(g,f),h=a.createElement("iframe"),h.addEventListener("error",function(a){i.reject(a)}),h.addEventListener("load",function(){return c.timeout(5e3).fail(function(){i.reject(new Error("Timeout while loading: "+b))})}),h.setAttribute("src",b),g.__path=b,g.element=d.element,g.state={},d.element.appendChild(h),g.__chan=e.build({window:h.contentWindow,origin:"*",scope:"renderJS"}),g.__chan.bind("declareMethod",function(a,b){return g[b]=function(){var a=arguments,d=new c.Promise(function(c,d){g.__chan.call({method:"methodCall",params:[b,Array.prototype.slice.call(a,0)],success:c,error:d})});return n(function(){return d})},"OK"}),g.__chan.bind("ready",function(a){return i.resolve(g),"OK"}),g.__chan.bind("failed",function(a,b){return i.reject(b),"OK"}),g.__chan.bind("acquire",function(a,b){(new c.Queue).push(function(){return g.__aq_parent.apply(g,b)}).then(a.complete).fail(function(b){a.error(b.toString())}),a.delayReturn(!0)}),i.promise}function J(a,b,e){return(new c.Queue).push(function(){return r(a)}).push(function(b){var c,e=(new d).parseFromString(b.responseText,"text/html"),f=e.createElement("base");return f.href=a,e.head.insertBefore(f,e.head.firstChild),c=new i([e.documentElement.outerHTML],{type:"text/html;charset=UTF-8"}),o(c)}).push(function(a){return I(a,b,e)})}function K(b,d,e,f){function g(a){return function(){return a.call(b,b)}}function h(){return a.contains(b.element)&&B(b),b}var i,j,k;if(y(b),j=d.scope,void 0===j)for(j="RJS_"+$,$+=1;e.__sub_gadget_dict.hasOwnProperty(j);)j="RJS_"+$,$+=1;if(e.__sub_gadget_dict[j]=b,b.element.setAttribute("data-gadget-scope",j),b.element.setAttribute("data-gadget-url",f),b.element.setAttribute("data-gadget-sandbox",d.sandbox),b.element._gadget=b,b.constructor.__ready_list.length){for(k=new c.Queue,i=0;i<b.constructor.__ready_list.length;i+=1)k.push(g(b.constructor.__ready_list[i]));return k.push(h),k}return h()}function L(a,b){var c,e,f;c=function(){v.call(this)},c.__ready_list=[],c.__service_list=v.__service_list.slice(),c.declareMethod=v.declareMethod,c.declareJob=v.declareJob,c.declareAcquiredMethod=v.declareAcquiredMethod,c.allowPublicAcquisition=v.allowPublicAcquisition,c.ready=v.ready,c.setState=v.setState,c.onStateChange=v.onStateChange,c.declareService=v.declareService,c.onEvent=v.onEvent,c.onLoop=v.onLoop,c.prototype=new v,c.prototype.constructor=c,c.prototype.__path=b,c.prototype.__acquired_method_dict={},c.__template_element=(new d).parseFromString(a.responseText,"text/html"),f=S.parseGadgetHTMLDocument(c.__template_element,b);for(e in f)f.hasOwnProperty(e)&&(c.prototype["__"+e]=f[e]);return c.__template_element.querySelectorAll("[data-gadget-url]").length&&c.__ready_list.push(z),c}function M(b,d,e){var h,i,j=S.parseGadgetHTMLDocument(a,d),k=a.createDocumentFragment();for(i in j)j.hasOwnProperty(i)&&(b.prototype["__"+i]=j[i]);for(b.__template_element=a.createElement("div"),e.element=a.body,e.state={},h=0;h<e.element.childNodes.length;h+=1)k.appendChild(e.element.childNodes[h].cloneNode(!0));return b.__template_element.appendChild(k),c.all([e.getRequiredJSList(),e.getRequiredCSSList()]).then(function(a){var b,c=a[0],d=a[1];for(b=0;b<c.length;b+=1)X[c[b]]=null;for(b=0;b<d.length;b+=1)Y[d[b]]=null;Z.shift()}).then(function(){var b=a.querySelector("body"),c=new f(function(b){var c,d,e,f,h,i;b.forEach(function(b){if("childList"===b.type){for(e=b.removedNodes.length,c=0;e>c;c+=1)if(h=b.removedNodes[c],h.nodeType===g.ELEMENT_NODE)for(h.hasAttribute("data-gadget-url")&&void 0!==h._gadget&&w(h._gadget),i=h.querySelectorAll("[data-gadget-url]"),f=i.length,d=0;f>d;d+=1)h=i[d],void 0!==h._gadget&&w(h._gadget);for(e=b.addedNodes.length,c=0;e>c;c+=1)if(h=b.addedNodes[c],h.nodeType===g.ELEMENT_NODE)for(h.hasAttribute("data-gadget-url")&&void 0!==h._gadget&&a.contains(h)&&B(h._gadget),i=h.querySelectorAll("[data-gadget-url]"),f=i.length,d=0;f>d;d+=1)h=i[d],a.contains(h)&&void 0!==h._gadget&&B(h._gadget)}})}),d={childList:!0,subtree:!0,attributes:!1,characterData:!1};return c.observe(b,d),e})}function N(){var a=new v;return a.__acquired_method_dict={reportServiceError:function(a){t(a[0])}},a.__aq_parent=function(a){throw new S.AcquisitionError("No gadget provides "+a)},a}function O(a){var d,f,g,h,i,j,k,l;if(W.hasOwnProperty(a))throw new Error("bootstrap should not be called twice");return d=E,d.__ready_list=[],d.__service_list=v.__service_list.slice(),d.prototype.__path=a,f=new E,D(f,N()),i=["getInterfaceList","getRequiredCSSList","getRequiredJSList","getPath","getTitle"],h=function(a){i.push(a)},l=[d,f,g,i],b.self===b.top?j=l:(k=c.defer(),j=c.any([k.promise,(new c.Queue).push(function(){return c.delay(1e3)}).push(function(){return l[2]=void 0,l})]),g=e.build({window:b.parent,origin:"*",scope:"renderJS",onReady:function(){var a,b;for(h=function(a){i.push(new c.Promise(function(b,c){g.call({method:"declareMethod",params:a,success:b,error:c})}))},b=i.length,a=0;b>a;a+=1)h(i[a]);k.resolve(l)}}),l[2]=g),d.declareMethod=function(a,b){var c=v.declareMethod.apply(this,[a,b]);return h(a),c},d.declareService=v.declareService,d.declareJob=v.declareJob,d.onEvent=v.onEvent,d.onLoop=v.onLoop,d.declareAcquiredMethod=v.declareAcquiredMethod,d.allowPublicAcquisition=v.allowPublicAcquisition,d.prototype.__acquired_method_dict={},Z.push(d),j}function P(a,b){function d(a){return function(){return a.call(b,b)}}var e,f=new c.Queue;for(a.ready(function(){return B(b)}),e=0;e<a.__ready_list.length;e+=1)f.push(d(a.__ready_list[e]));return f}function Q(a,b,d){b.__aq_parent=a.prototype.__aq_parent=function(a,b,e){return new c.Promise(function(c,f){d.call({method:"acquire",params:[a,b],success:c,error:f,timeout:e})})},d.bind("methodCall",function(a,c){b[c[0]].apply(b,c[1]).push(a.complete,function(b){a.error(b.toString())}),a.delayReturn(!0)})}function R(a){var b,d,e,f,g=O(a);return(new c.Queue).push(function(){return g}).push(function(a){return b=a[0],d=a[1],e=a[2],f=a[3],V.promise}).push(function(){return c.all(f)}).push(function(c){return void 0!==e&&Q(b,d,e),M(b,a,d)}).push(function(){return y(d),b.__ready_list.unshift(z),P(b,d)}).push(function(){void 0!==e&&e.notify({method:"ready"})}).push(void 0,function(a){throw t(a),void 0!==e&&e.notify({method:"failed",params:a.toString()}),a})}m.prototype=new Error,m.prototype.constructor=m;var S,T,U,V,W={},X={},Y={},Z=[],$=0,_=new RegExp("^(?:[a-z]+:)?//|data:","i"),aa=!1,ba=[];b.addEventListener("error",function(a){ba.push(a)}),b.addEventListener("beforeunload",function(){aa=!0}),U=function(){return this instanceof U?void(this._latest_promise=null):new U},U.prototype={constructor:U,lockAndRun:function(a){var b=this._latest_promise;return null===b?this._latest_promise=c.resolve(a()):this._latest_promise=this._latest_promise.always(function(){return a()}),this._latest_promise}},u.prototype=new Error,u.prototype.constructor=u,T=function(){function a(){var a,b=g.length;for(a=0;b>a;a+=1)g[a].cancel();g=[]}var b,d,e,f=this,g=[];return this instanceof T?(b=new c.Promise(function(b,c){d=function(b){return e?void 0:(f.isRejected=!0,f.rejectedReason=b,e=!0,a(),c(b))}},a),f.cancel=function(){e||(e=!0,b.cancel(),b.fail(function(a){f.isRejected=!0,f.rejectedReason=a}))},f.then=b.then.bind(b),f.fail=b.fail.bind(b),void(f.monitor=function(a){if(e)throw new u;var b=(new c.Queue).push(function(){return a}).push(function(a){var b,c,d=g.length,e=[];for(c=0;d>c;c+=1)b=g[c],b.isFulfilled||b.isRejected||e.push(b);g=e},function(b){throw b instanceof c.CancellationError&&(a.isFulfilled&&a.isRejected||a.cancel()),d(b),b});return g.push(b),this})):new T},T.prototype=Object.create(c.Promise.prototype),T.prototype.constructor=T,v.prototype.__title="",v.prototype.__interface_list=[],v.prototype.__path="",v.prototype.__html="",v.prototype.__required_css_list=[],v.prototype.__required_js_list=[],v.__ready_list=[],v.ready=function(a){return this.__ready_list.push(a),this},v.setState=function(a){return this.prototype.__json_state=JSON.stringify(a),this},v.onStateChange=function(a){return this.prototype.__state_change_callback=a,this},v.__service_list=[],v.declareService=function(a){return this.__service_list.push(a),this},v.onEvent=function(a,b,c,d){return this.__service_list.push(function(){return p(this.element,a,c,b.bind(this),d)}),this},v.onLoop=function(a,b){return void 0===b&&(b=0),this.__service_list.push(function(){var d=new c.Queue,e=this,f=function(){d.push(function(){return c.delay(b)}).push(function(){return q()}).push(function(){return a.apply(e,[])}).push(f)};return f(),d}),this},v.declareJob=function(a,b){return this.__job_declared=!0,this.prototype[a]=function(){var c=this,d=arguments;c.__job_triggered?A(c,a,b,d):c.__job_list.push([a,b,d])},this},v.declareMethod=function(a,b,c){return this.prototype[a]=function(){function a(){return b.apply(e,f)}var d,e=this,f=arguments;return void 0!==c&&c.hasOwnProperty("mutex")?(d="__mutex_"+c.mutex,e.hasOwnProperty(d)||(e[d]=new U),n(e[d].lockAndRun,[a],e[d])):n(b,f,e)},this},v.declareMethod("getInterfaceList",function(){return this.__interface_list}).declareMethod("getRequiredCSSList",function(){return this.__required_css_list}).declareMethod("getRequiredJSList",function(){return this.__required_js_list}).declareMethod("getPath",function(){return this.__path}).declareMethod("getTitle",function(){return this.__title}).declareMethod("getElement",function(){if(void 0===this.element)throw new Error("No element defined");return this.element}).declareMethod("changeState",function(a){var b,c,d=this,e=!1,f=d.hasOwnProperty("__modification_dict");f?(c=d.__modification_dict,e=!0):c={};for(b in a)a.hasOwnProperty(b)&&a[b]!==d.state[b]&&(d.state[b]=a[b],c[b]=a[b],e=!0);return e&&void 0!==d.__state_change_callback?(d.__modification_dict=c,n(d.__state_change_callback,[c],d).push(function(a){return delete d.__modification_dict,a})):void 0},{mutex:"changestate"}),v.declareAcquiredMethod=function(a,b){return this.prototype[a]=function(){var a=Array.prototype.slice.call(arguments,0),c=this;return n(c.__aq_parent,[b,a],c)},this},v.declareAcquiredMethod("aq_reportServiceError","reportServiceError"),v.declareAcquiredMethod("aq_reportGadgetDeclarationError","reportGadgetDeclarationError"),v.allowPublicAcquisition=function(a,b){return this.prototype.__acquired_method_dict[a]=b,this},E.__ready_list=[],E.__service_list=v.__service_list.slice(),E.ready=v.ready,E.setState=v.setState,E.onStateChange=v.onStateChange,E.declareService=v.declareService,E.onEvent=v.onEvent,E.onLoop=v.onLoop,E.prototype=new v,E.prototype.constructor=E,H.__ready_list=[],H.ready=v.ready,H.setState=v.setState,H.onStateChange=v.onStateChange,H.__service_list=[],H.declareService=v.declareService,H.onEvent=v.onEvent,H.onLoop=v.onLoop,H.prototype=new v,H.prototype.constructor=H,v.declareMethod("declareGadget",function(a,b){var d,e,f=this;if(void 0===b&&(b={}),void 0===b.sandbox&&(b.sandbox="public"),a=S.getAbsoluteURL(a,this.__path),"public"===b.sandbox)d=G;else if("iframe"===b.sandbox)d=I;else{if("dataurl"!==b.sandbox)throw new Error("Unsupported sandbox options '"+b.sandbox+"'");d=J}return e=d(a,b,f),"function"==typeof e.then?(new c.Queue).push(function(){return e}).push(function(c){return K(c,b,f,a)}):K(e,b,f,a)}).declareMethod("getDeclaredGadget",function(a){if(!this.__sub_gadget_dict.hasOwnProperty(a))throw new m("Gadget scope '"+a+"' is not known.");return this.__sub_gadget_dict[a]}).declareMethod("dropGadget",function(a){if(!this.__sub_gadget_dict.hasOwnProperty(a))throw new m("Gadget scope '"+a+"' is not known.");delete this.__sub_gadget_dict[a]}),S=function(a){var c;if(a===b&&(c=Z[0]),void 0===c)throw new Error("Unknown selector '"+a+"'");return c},S.AcquisitionError=function(a){if(this.name="AcquisitionError",void 0!==a&&"string"!=typeof a)throw new TypeError("You must pass a string.");this.message=a||"Acquisition failed"},S.AcquisitionError.prototype=new Error,S.AcquisitionError.prototype.constructor=S.AcquisitionError,S.getAbsoluteURL=function(a,b){return b&&a?new l(a,b).href:a},S.declareJS=function(b,d,e){var f;return X.hasOwnProperty(b)?f=c.resolve():(X[b]=null,f=new c.Promise(function(c,f){var g;g=a.createElement("script"),g.async=!1,g.type="text/javascript",g.onload=function(){e===!0&&Z.shift(),c()},g.onerror=function(a){e===!0&&Z.shift(),f(a)},g.src=b,d.appendChild(g)})),f},S.declareCSS=function(b,d){var e;return e=Y.hasOwnProperty(b)?c.resolve():new c.Promise(function(c,e){var f;f=a.createElement("link"),f.rel="stylesheet",f.type="text/css",f.href=b,f.onload=function(){Y[b]=null,c()},f.onerror=e,d.appendChild(f)})},S.declareGadgetKlass=function(b){var d,e;if(W.hasOwnProperty(b)){if(W[b].hasOwnProperty("defer_list"))return e=c.defer(),W[b].defer_list.push(e),e.promise;if(W[b].is_resolved)return W[b].result;throw W[b].result}return W[b]={defer_list:[]},(new c.Queue).push(function(){return r(b)}).push(function(e){d=L(e,b);var f,g=a.createDocumentFragment(),h=[],i=d.prototype.__required_js_list,j=d.prototype.__required_css_list;if(i.length){for(Z.push(d),f=0;f<i.length-1;f+=1)h.push(S.declareJS(i[f],g));h.push(S.declareJS(i[f],g,!0))}for(f=0;f<j.length;f+=1)h.push(S.declareCSS(j[f],g));return a.head.appendChild(g),c.all(h)}).push(function(){var a,c=W[b].defer_list.length;for(a=0;c>a;a+=1)W[b].defer_list[a].resolve(d);return delete W[b].defer_list,W[b].result=d,W[b].is_resolved=!0,d}).push(void 0,function(a){var c,d=W[b].defer_list.length;for(c=0;d>c;c+=1)W[b].defer_list[c].reject(a);throw delete W[b].defer_list,W[b].result=a,W[b].is_resolved=!1,a})},S.clearGadgetKlassList=function(){W={},X={},Y={}},S.parseGadgetHTMLDocument=function(a,b){var c,d,e={title:"",interface_list:[],required_css_list:[],required_js_list:[]};if(!b||!_.test(b))throw new Error("The url should be absolute: "+b);if(9!==a.nodeType)throw new Error("The first parameter should be an HTMLDocument");if(e.title=a.title,null!==a.head)for(c=0;c<a.head.children.length;c+=1)d=a.head.children[c],null!==d.href&&("stylesheet"===d.rel?e.required_css_list.push(S.getAbsoluteURL(d.getAttribute("href"),b)):"SCRIPT"!==d.nodeName||"text/javascript"!==d.type&&d.type?"http://www.renderjs.org/rel/interface"===d.rel&&e.interface_list.push(S.getAbsoluteURL(d.getAttribute("href"),b)):e.required_js_list.push(S.getAbsoluteURL(d.getAttribute("src"),b)));return e},S.Mutex=U,S.ScopeError=m,b.rJS=b.renderJS=S,b.__RenderJSGadget=v,b.__RenderJSEmbeddedGadget=E,b.__RenderJSIframeGadget=H,V=new c.defer,S.manualBootstrap=function(){V.resolve()},a.addEventListener("DOMContentLoaded",V.resolve,!1),R(s(b.location.href))}(document,window,RSVP,DOMParser,Channel,MutationObserver,Node,FileReader,Blob,navigator,Event,URL);